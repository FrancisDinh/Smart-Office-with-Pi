# sc-iot-lab
This is the sc-iot-lab project.
By means of a raspberry pi and arduino, sensors and relays a smart building control is simulated.

The sensors are used to determine:
* Presence in the room (ultrasonic sensor; the pir sensor was unreliable)
* Presence at the door (For both sides of the door an array of two ultrasonic sensors connected to an arduino connected to the raspberry pi is used)
* Temperature in the room (temperature sensor)
* Lighting Conditions in the room (lightlevel sensor)
* Emergency trigger (button to simulate smoke detector detecting emergency mode)

The information gained by the sensors is sent to a server component via messaging queues and saved in a database for later access.
Then the server component uses the sensor data and transforms it to a pddl domain and problem, according to which the actions to satisfy a goal (generated according to the current operating mode) are sent to the actuators.

The actuators available are:
* Door control (relay + indicator led)
* Lamp (led)
* AC control (relay + indicator led)
* Emergency buzzer (to simulate alarm in emergency mode)


The system architecture consists of the following components:

* The server, receives sensor values, builds the state, saves it to a database, decides the operating mode and calls the pddl_planner with the state. It receives messages via lib/rabbitmq.
* The pddl_planner receives the state and executes the ff-planner with the domain and problem files, which are generated by the pddl_planner (from the state received).
* The pddl_actions_dispatcher receives a list of actions from the pddl_planner and sends the appropriate command to the actuators.
* The rest_api queries a database and makes the sensors and their values available to the frontend. It also allows manually overriding the current operating mode.
* The frontend displays sensor values and offers a web ui to switch between modes.
* The lib/rabbitmq component is a reusable connector for a rabbitmq instance. All other components use it to exchange messages.
* The lib/mongodb component is a reusable connector for a mongodb instance. The server saves the state and the rest_api reads it, as well as makes it available to the frontend.
* The client reads the sensor values, sends them to the server and receives commands for the actuators. It also uses lib/rabbitmq for communication.
* The client reads serial data from an additional arduino, which supplies distance information (two ultrasonic sensors) for the door.

For more detailed information, view the project report.

## Setup on Raspberry Pi
Setting up and running requires multiple steps.
To run it on the raspberry pi, connect the grovepi.
Then connect the sensors and actuators to the ports on the grovepi specified in the client component.
Sometimes the raspberry pi can have issues detecting the grovepi, which can be solved by rebooting the raspberry pi. 
```
sudo reboot
```

Checking if the grovepi is recognized:
```
sudo i2detect -y -r 1
```
Copy this project repository to the raspberry pi.

Then the [ff planner](https://fai.cs.uni-saarland.de/hoffmann/ff.html) must be compiled:
```
cd code/pddl/ff-v2.3
make
```

### Setup on Raspberry Pi: Docker
```
curl -sSL https://get.docker.com | sh
sudo apt install -y docker-compose
```
Copy the docker-compose.yml file (which starts the rabbitmq message broker) from the repository root folder to the raspberry pi.
```
sudo docker-compose up -d
```

### Setup on Raspberry Pi: Python 3
```
sudo apt install python3-pymongo
pip3 install pika
pip3 install pyserial
pip3 install flask flask-cors

```
The [grovepi](https://github.com/DexterInd/GrovePi) library needs to be setup as well.

### Setup on Raspberry Pi: MongoDB
The MongoDD is used to save sensor values received by the server via rabbitmq.
```
sudo apt install -y mongodb
```

### Setup the arduino
Load the code from the code/arduino-sensors/person_atdoor_ultrasonic_pair_sensors.ino file on the arduino and connect it via usb to the raspberry pi.

### Running on Raspberry Pi
```
cd code
python3 server.py &
python3 client.py &
python3 rest_api.py &
```

### Setup and Run the Frontend
The frontend enables easy viewing of current sensor values and overriding of operating mode.
It is intended to run on any machine other than the raspberry pi, but connects to it.
To use it, download and install [node.js](https://nodejs.org/en/) and [angular](https://angular.io/guide/setup-local).
Then go to the code/frontend/src/app/sensor/sensor.service.ts file and change the baseUrl value to the address of the rest_api on the raspberry pi.
```
cd code/frontend
ng serve --open
```

### Local testing
Modify/write a client to send/receive dummy sensor values/actuator commands.
Skip the grovepi, mongodb and rabbitmq setup.
Instead:
```
docker run -d --rm --hostname rabbit-broker --name rabbit-broker -p 5672:5672 -p 15672:15672 rabbitmq:3.7.15
docker run -d --rm --hostname mongodb --name mongodb -p 27019:27019 -p 27017:27017 -p 27018:27018 mongo:3.4.21-xenial
```
Otherwise the use is the same as the raspberry pi.
